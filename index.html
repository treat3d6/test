<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yeat Stats</title>
    <script src="https://unpkg.com/react@18/umd/react.development.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.min.js" crossorigin></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/recharts@2.10.3/dist/Recharts.min.js" crossorigin></script>
    <style>
        @media (max-width: 640px) {
            .table-container {
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>
<body class="bg-black">
    <div id="root">
        <div style="color: white; padding: 20px;">Loading...</div>
    </div>

    <script type="text/babel">
        console.log('Script starting...');
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = window.Recharts;

        const YeatStats = () => {
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [songs, setSongs] = React.useState([]);
            const [currentDate, setCurrentDate] = React.useState('');

            React.useEffect(() => {
                const loadData = async () => {
                    try {
                        setLoading(true);
                        // Load dates.json
                        const response = await fetch('./dates.json');
                        if (!response.ok) throw new Error('Failed to load dates.json');
                        const data = await response.json();
                        console.log('Loaded dates:', data);

                        // Load the latest CSV file
                        if (data.dates && data.dates.length > 0) {
                            const latestDate = data.dates[data.dates.length - 1];
                            setCurrentDate(latestDate);
                            
                            const csvResponse = await fetch(`./data/${latestDate}.csv`);
                            if (!csvResponse.ok) throw new Error('Failed to load CSV');
                            const text = await csvResponse.text();
                            
                            // Parse CSV with your actual column names
                            Papa.parse(text, {
                                header: true,
                                skipEmptyLines: true,
                                complete: (results) => {
                                    console.log('Parsed CSV:', results.data[0]); // Log first row
                                    const processedSongs = results.data.map(row => ({
                                        title: row.Song,
                                        album: row.Album,
                                        streams: parseInt(row['Spotify total'].replace(/,/g, '')) || 0,
                                        daily: parseInt(row['Spotify daily'].replace(/,/g, '')) || 0
                                    }));
                                    setSongs(processedSongs);
                                },
                                error: (error) => {
                                    console.error('CSV Parse Error:', error);
                                    setError('Failed to parse CSV: ' + error.message);
                                }
                            });
                        }
                    } catch (err) {
                        console.error('Error:', err);
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                };

                loadData();
            }, []);

            if (loading) {
                return (
                    <div className="text-white p-4">
                        Loading data...
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="text-white p-4">
                        <h1 className="text-xl font-bold mb-4">Error Loading Data</h1>
                        <pre className="text-red-500">{error}</pre>
                    </div>
                );
            }

            return (
                <div className="text-white p-4">
                    <h1 className="text-xl font-bold mb-4">Top Songs</h1>
                    <p className="mb-4">Last updated: {currentDate}</p>
                    <div className="overflow-x-auto">
                        <table className="min-w-full">
                            <thead>
                                <tr>
                                    <th className="text-left p-2">Song</th>
                                    <th className="text-left p-2">Album</th>
                                    <th className="text-right p-2">Total Streams</th>
                                    <th className="text-right p-2">Daily Streams</th>
                                </tr>
                            </thead>
                            <tbody>
                                {songs.map((song, index) => (
                                    <tr key={index} className={index % 2 === 0 ? 'bg-black' : 'bg-white/5'}>
                                        <td className="p-2">{song.title}</td>
                                        <td className="p-2">{song.album}</td>
                                        <td className="p-2 text-right">{song.streams.toLocaleString()}</td>
                                        <td className="p-2 text-right">{song.daily.toLocaleString()}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        window.addEventListener('load', function() {
            console.log('Window loaded, rendering app...');
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<YeatStats />);
        });
    </script>
</body>
</html>
